def PIPELINE_ID = "${env.BUILD_NUMBER}"

def getImageTag() {
    def dateFormat = new java.text.SimpleDateFormat('yyyyMMddHHmmss')
    def currentDate = new Date()
    return dateFormat.format(currentDate)
}

podTemplate(
    label: "${PIPELINE_ID}",
    serviceAccount: 'jenkins',
    containers: [
        containerTemplate(name: 'gradle', image: 'gradle:jdk17', ttyEnabled: true, command: 'cat'),
        containerTemplate(name: 'docker', image: 'docker:20.10.16-dind', ttyEnabled: true, privileged: true),
        containerTemplate(name: 'git', image: 'alpine/git:latest', command: 'cat', ttyEnabled: true)
    ],
    volumes: [
        emptyDirVolume(mountPath: '/home/gradle/.gradle', memory: false),
        emptyDirVolume(mountPath: '/var/run', memory: false)
    ]
) {
    node(PIPELINE_ID) {
        def props
        def imageTag = getImageTag()
        def services = ['member', 'store', 'marketing-content', 'ai-recommend']
        
        // Manifest Repository ì„¤ì •
        def MANIFEST_REPO = 'https://github.com/won-ktds/smarketing-manifest.git'
        def MANIFEST_CREDENTIAL_ID = 'github-credentials-smarketing'

        try {
            stage("Get Source") {
                checkout scm
                
                // smarketing-java í•˜ìœ„ì— ìˆëŠ” ì„¤ì • íŒŒì¼ ì½ê¸°
                props = readProperties file: "smarketing-java/deployment/deploy_env_vars"

                echo "=== Build Information ==="
                echo "Services: ${services}"
                echo "Image Tag: ${imageTag}"
                echo "Registry: ${props.registry}"
                echo "Image Org: ${props.image_org}"
                
                // Azure Blob Storage í™˜ê²½ë³€ìˆ˜ í™•ì¸
                echo "=== Azure Blob Storage Configuration ==="
                echo "Storage Account: ${props.AZURE_STORAGE_ACCOUNT_NAME}"
                echo "Storage Container: ${props.AZURE_STORAGE_CONTAINER_NAME}"
                echo "Menu Container: ${props.AZURE_STORAGE_MENU_CONTAINER}"
                echo "Store Container: ${props.AZURE_STORAGE_STORE_CONTAINER}"
            }

            stage("Check Changes") {
                script {
                    def changes = sh(
                        script: "git diff --name-only HEAD~1 HEAD",
                        returnStdout: true
                    ).trim()

                    if (!changes.contains("smarketing-java/")) {
                        echo "No changes in smarketing-java, skipping build"
                        currentBuild.result = 'SUCCESS'
                        error("Stopping pipeline - no changes detected")
                    }

                    echo "Changes detected in smarketing-java, proceeding with build"
                }
            }

            stage('Build Applications') {
                container('gradle') {
                    sh """
                        echo "=== smarketing-java ë””ë ‰í† ë¦¬ë¡œ ì´ë™ ==="
                        cd smarketing-java
                        
                        echo "=== gradlew ê¶Œí•œ ì„¤ì • ==="
                        chmod +x gradlew
                        
                        echo "=== ì „ì²´ ì„œë¹„ìŠ¤ ë¹Œë“œ ==="
                        ./gradlew :member:clean :member:build -x test
                        ./gradlew :store:clean :store:build -x test
                        ./gradlew :marketing-content:clean :marketing-content:build -x test
                        ./gradlew :ai-recommend:clean :ai-recommend:build -x test
                        
                        echo "=== ë¹Œë“œ ê²°ê³¼ í™•ì¸ ==="
                        find . -name "*.jar" -path "*/build/libs/*" | grep -v 'plain.jar'
                    """
                }
            }

            stage('Build & Push Images') {
                container('docker') {
                    sh """
                        echo "=== Docker ë°ëª¬ ì‹œì‘ ëŒ€ê¸° ==="
                        timeout 30 sh -c 'until docker info; do sleep 1; done'
                    """

                    // ACR Credentialì„ Jenkinsì—ì„œ ì§ì ‘ ì‚¬ìš©
                    withCredentials([usernamePassword(
                        credentialsId: 'acr-credentials',
                        usernameVariable: 'ACR_USERNAME',
                        passwordVariable: 'ACR_PASSWORD'
                    )]) {
                        sh """
                            echo "=== Dockerë¡œ ACR ë¡œê·¸ì¸ ==="
                            echo "\$ACR_PASSWORD" | docker login ${props.registry} --username \$ACR_USERNAME --password-stdin
                        """

                        services.each { service ->
                            script {
                                def buildDir = "smarketing-java/${service}"
                                def fullImageName = "${props.registry}/${props.image_org}/${service}:${imageTag}"

                                echo "Building image for ${service}: ${fullImageName}"
                                
                                // ì‹¤ì œ JAR íŒŒì¼ëª… ë™ì  íƒì§€
                                def actualJarFile = sh(
                                    script: """
                                        cd ${buildDir}/build/libs
                                        ls *.jar | grep -v 'plain.jar' | head -1
                                    """,
                                    returnStdout: true
                                ).trim()
                                
                                if (!actualJarFile) {
                                    error "${service} JAR íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
                                }
                                
                                echo "ë°œê²¬ëœ JAR íŒŒì¼: ${actualJarFile}"

                                sh """
                                    echo "=== ${service} ì´ë¯¸ì§€ ë¹Œë“œ ==="
                                    docker build \\
                                        --build-arg BUILD_LIB_DIR="${buildDir}/build/libs" \\
                                        --build-arg ARTIFACTORY_FILE="${actualJarFile}" \\
                                        -f smarketing-java/deployment/container/Dockerfile \\
                                        -t ${fullImageName} .

                                    echo "=== ${service} ì´ë¯¸ì§€ í‘¸ì‹œ ==="
                                    docker push ${fullImageName}
                                    
                                    echo "Successfully built and pushed: ${fullImageName}"
                                """
                            }
                        }
                    }
                }
            }

            stage('Update Manifest Repository') {
                container('git') {
                    script {
                        // Manifest Repository Clone
                        withCredentials([usernamePassword(
                            credentialsId: MANIFEST_CREDENTIAL_ID,
                            usernameVariable: 'GIT_USERNAME',
                            passwordVariable: 'GIT_PASSWORD'
                        )]) {
                            sh """
                                echo "=== Git ì„¤ì • ==="
                                git config --global user.name "Jenkins CI"
                                git config --global user.email "jenkins@company.com"
                                
                                echo "=== Manifest Repository Clone ==="
                                rm -rf manifest-repo
                                git clone https://\$GIT_USERNAME:\$GIT_PASSWORD@github.com/won-ktds/smarketing-manifest.git manifest-repo
                                cd manifest-repo
                            """
                            
                            services.each { service ->
                                def fullImageName = "${props.registry}/${props.image_org}/${service}:${imageTag}"
                                def deploymentFile = "smarketing/deployments/${service}/${service}-deployment.yaml"
                                
                                sh """
                                    cd manifest-repo
                                    
                                    echo "=== ${service} Deployment íŒŒì¼ ì—…ë°ì´íŠ¸ ==="
                                    if [ -f "${deploymentFile}" ]; then
                                        # ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸
                                        sed -i 's|image: ${props.registry}/${props.image_org}/${service}:.*|image: ${fullImageName}|g' "${deploymentFile}"
                                        echo "Updated ${deploymentFile} with new image: ${fullImageName}"
                                        
                                        # Azure Blob Storage í™˜ê²½ë³€ìˆ˜ ì—…ë°ì´íŠ¸ (ConfigMap/Secretì— ìˆëŠ” ê²½ìš°)
                                        # ConfigMap ì—…ë°ì´íŠ¸
                                        if [ -f "smarketing/configmaps/${service}-configmap.yaml" ]; then
                                            echo "=== ${service} ConfigMap ì—…ë°ì´íŠ¸ ==="
                                            # ConfigMapì—ì„œ Azure Storage ê´€ë ¨ ì„¤ì • ì—…ë°ì´íŠ¸
                                            sed -i 's|AZURE_STORAGE_ACCOUNT_NAME:.*|AZURE_STORAGE_ACCOUNT_NAME: "${props.AZURE_STORAGE_ACCOUNT_NAME}"|g' "smarketing/configmaps/${service}-configmap.yaml"
                                            sed -i 's|AZURE_STORAGE_CONTAINER_NAME:.*|AZURE_STORAGE_CONTAINER_NAME: "${props.AZURE_STORAGE_CONTAINER_NAME}"|g' "smarketing/configmaps/${service}-configmap.yaml"
                                            sed -i 's|AZURE_STORAGE_MENU_CONTAINER:.*|AZURE_STORAGE_MENU_CONTAINER: "${props.AZURE_STORAGE_MENU_CONTAINER}"|g' "smarketing/configmaps/${service}-configmap.yaml"
                                            sed -i 's|AZURE_STORAGE_STORE_CONTAINER:.*|AZURE_STORAGE_STORE_CONTAINER: "${props.AZURE_STORAGE_STORE_CONTAINER}"|g' "smarketing/configmaps/${service}-configmap.yaml"
                                            sed -i 's|AZURE_STORAGE_ENDPOINT:.*|AZURE_STORAGE_ENDPOINT: "${props.AZURE_STORAGE_ENDPOINT}"|g' "smarketing/configmaps/${service}-configmap.yaml"
                                            sed -i 's|AZURE_STORAGE_MAX_FILE_SIZE:.*|AZURE_STORAGE_MAX_FILE_SIZE: "${props.AZURE_STORAGE_MAX_FILE_SIZE}"|g' "smarketing/configmaps/${service}-configmap.yaml"
                                        fi
                                        
                                        # Secret ì—…ë°ì´íŠ¸
                                        if [ -f "smarketing/secrets/${service}-secret.yaml" ]; then
                                            echo "=== ${service} Secret ì—…ë°ì´íŠ¸ ==="
                                            # Base64 ì¸ì½”ë”©ëœ Azure Storage Account Key ì—…ë°ì´íŠ¸
                                            ENCODED_KEY=\$(echo -n "${props.AZURE_STORAGE_ACCOUNT_KEY}" | base64 -w 0)
                                            sed -i "s|AZURE_STORAGE_ACCOUNT_KEY:.*|AZURE_STORAGE_ACCOUNT_KEY: \$ENCODED_KEY|g" "smarketing/secrets/${service}-secret.yaml"
                                        fi
                                        
                                        # ë³€ê²½ì‚¬í•­ í™•ì¸
                                        echo "=== ë³€ê²½ëœ ë‚´ìš© í™•ì¸ ==="
                                        grep "image: ${props.registry}/${props.image_org}/${service}" "${deploymentFile}" || echo "ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸ í™•ì¸ ì‹¤íŒ¨"
                                    else
                                        echo "Warning: ${deploymentFile} not found"
                                    fi
                                """
                            }
                            
                            sh """
                                cd manifest-repo
                                
                                echo "=== Git ë³€ê²½ì‚¬í•­ í™•ì¸ ==="
                                git status
                                git diff
                                
                                # ë³€ê²½ì‚¬í•­ì´ ìˆìœ¼ë©´ ì»¤ë°‹ ë° í‘¸ì‹œ
                                if [ -n "\$(git status --porcelain)" ]; then
                                    git add .
                                    git commit -m "Update SMarketing services to ${imageTag} with Azure Storage config - Build ${env.BUILD_NUMBER}"
                                    git push origin main
                                    echo "âœ… Successfully updated manifest repository with Azure Storage configuration"
                                else
                                    echo "â„¹ï¸ No changes to commit"
                                fi
                            """
                        }
                    }
                }
            }

            stage('Trigger ArgoCD Sync') {
                script {
                    echo """
ğŸ¯ CI Pipeline ì™„ë£Œ!

ğŸ“¦ ë¹Œë“œëœ ì´ë¯¸ì§€ë“¤:
${services.collect { "- ${props.registry}/${props.image_org}/${it}:${imageTag}" }.join('\n')}

ğŸ”§ Azure Blob Storage ì„¤ì • ì—…ë°ì´íŠ¸:
- Storage Account: ${props.AZURE_STORAGE_ACCOUNT_NAME}
- Container: ${props.AZURE_STORAGE_CONTAINER_NAME}
- Menu Container: ${props.AZURE_STORAGE_MENU_CONTAINER}
- Store Container: ${props.AZURE_STORAGE_STORE_CONTAINER}

ğŸ”„ ArgoCD ë™ì‘:
- ArgoCDê°€ manifest repository ë³€ê²½ì‚¬í•­ì„ ìë™ìœ¼ë¡œ ê°ì§€í•©ë‹ˆë‹¤
- ê° ì„œë¹„ìŠ¤ë³„ Applicationì´ ìƒˆë¡œìš´ ì´ë¯¸ì§€ë¡œ ë™ê¸°í™”ë©ë‹ˆë‹¤
- Azure Blob Storage í™˜ê²½ë³€ìˆ˜ê°€ ConfigMap/Secretì— ë°˜ì˜ë©ë‹ˆë‹¤
- ArgoCD UIì—ì„œ ë°°í¬ ìƒíƒœë¥¼ ëª¨ë‹ˆí„°ë§í•˜ì„¸ìš”

ğŸŒ ArgoCD UI: [ArgoCD ì ‘ì† URL]
ğŸ“ Manifest Repo: ${MANIFEST_REPO}
                    """
                }
            }

            // ì„±ê³µ ì‹œ ì²˜ë¦¬
            echo """
âœ… CI Pipeline ì„±ê³µ!
ğŸ·ï¸ ìƒˆë¡œìš´ ì´ë¯¸ì§€ íƒœê·¸: ${imageTag}
ğŸ”§ Azure Blob Storage ì„¤ì • ì—…ë°ì´íŠ¸ ì™„ë£Œ
ğŸ”„ ArgoCDê°€ ìë™ìœ¼ë¡œ ë°°í¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤
            """

        } catch (Exception e) {
            // ì‹¤íŒ¨ ì‹œ ì²˜ë¦¬
            echo "âŒ CI Pipeline ì‹¤íŒ¨: ${e.getMessage()}"
            throw e
        } finally {
            // ì •ë¦¬ ì‘ì—… (í•­ìƒ ì‹¤í–‰)
            container('docker') {
                sh 'docker system prune -f || true'
            }
            sh 'rm -rf manifest-repo || true'
        }
    }
}
